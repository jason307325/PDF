<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>PDF 多關鍵字螢光筆（累加 / 可匯出列印）</title>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>

<style>
body { font-family: Arial, sans-serif; margin: 10px; }
#controls { margin-bottom: 10px; }
.page { position: relative; margin-bottom: 20px; }
.textLayer { position: absolute; inset: 0; pointer-events: none; }
.highlight { position: absolute; }
</style>
</head>

<body>

<div id="controls">
  <input type="file" id="fileInput" accept="application/pdf">
  <input type="text" id="keyword" placeholder="輸入關鍵字（逗號分隔）" style="width:260px">
  <button onclick="search()">新增標記</button>
  <button onclick="exportPDF()">匯出已標記 PDF</button>
</div>

<div id="pdf-container"></div>

<script>
pdfjsLib.GlobalWorkerOptions.workerSrc =
  "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

const SCALE = 1.5;
const COLORS = [
  PDFLib.rgb(1, 1, 0),
  PDFLib.rgb(0, 1, 0),
  PDFLib.rgb(0, 1, 1),
  PDFLib.rgb(1, 0.6, 0),
  PDFLib.rgb(1, 0, 1)
];

let pdfDoc = null;
let originalPdfBytes = null;
let pagesData = [];
let highlights = [];
let usedKeywords = new Set(); // ✅ 已搜尋關鍵字

document.getElementById("fileInput").addEventListener("change", async e => {
  const file = e.target.files[0];
  if (!file) return;

  originalPdfBytes = await file.arrayBuffer();
  pdfDoc = await pdfjsLib.getDocument(originalPdfBytes).promise;

  document.getElementById("pdf-container").innerHTML = "";
  pagesData = [];
  highlights = [];
  usedKeywords.clear();

  for (let i = 1; i <= pdfDoc.numPages; i++) {
    await renderPage(i);
  }
});

async function renderPage(pageNum) {
  const page = await pdfDoc.getPage(pageNum);
  const viewport = page.getViewport({ scale: SCALE });

  const pageDiv = document.createElement("div");
  pageDiv.className = "page";
  pageDiv.style.width = viewport.width + "px";
  pageDiv.style.height = viewport.height + "px";

  const canvas = document.createElement("canvas");
  canvas.width = viewport.width;
  canvas.height = viewport.height;

  await page.render({ canvasContext: canvas.getContext("2d"), viewport }).promise;

  const textLayer = document.createElement("div");
  textLayer.className = "textLayer";

  pageDiv.appendChild(canvas);
  pageDiv.appendChild(textLayer);
  document.getElementById("pdf-container").appendChild(pageDiv);

  const textContent = await page.getTextContent();
  pagesData.push({ pageNum, textContent, viewport, textLayer });
}

function search() {
  const raw = document.getElementById("keyword").value;
  if (!raw) return;

  const keywords = raw
    .split(",")
    .map(k => k.trim().toLowerCase())
    .filter(k => k && !usedKeywords.has(k));

  if (!keywords.length) return;

  keywords.forEach(k => usedKeywords.add(k));

  pagesData.forEach(data => {
    data.textContent.items.forEach(item => {
      const text = item.str.toLowerCase();

      keywords.forEach((kw, index) => {
        if (text.includes(kw)) {
          const t = pdfjsLib.Util.transform(
            data.viewport.transform,
            item.transform
          );

          const x = t[4];
          const y = t[5] - item.height;
          const w = item.width * data.viewport.scale;
          const h = item.height * data.viewport.scale;

          // 畫面顯示（累加）
          const div = document.createElement("div");
          div.className = "highlight";
          div.style.left = x + "px";
          div.style.top = y + "px";
          div.style.width = w + "px";
          div.style.height = h + "px";
          div.style.background = "rgba(255,255,0,0.35)";
          data.textLayer.appendChild(div);

          // 匯出用
          highlights.push({
            page: data.pageNum - 1,
            x: x / data.viewport.scale,
            y: (data.viewport.height - y - h) / data.viewport.scale,
            w: w / data.viewport.scale,
            h: h / data.viewport.scale,
            color: COLORS[usedKeywords.size % COLORS.length]
          });
        }
      });
    });
  });
}

async function exportPDF() {
  if (!highlights.length) {
    alert("尚未有任何標記");
    return;
  }

  const pdfDocLib = await PDFLib.PDFDocument.load(originalPdfBytes);
  const pages = pdfDocLib.getPages();

  highlights.forEach(h => {
    pages[h.page].drawRectangle({
      x: h.x,
      y: h.y,
      width: h.w,
      height: h.h,
      color: h.color,
      blendMode: PDFLib.BlendMode.Multiply,
      borderWidth: 0
    });
  });

  const pdfBytes = await pdfDocLib.save();
  const blob = new Blob([pdfBytes], { type: "application/pdf" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "highlighted.pdf";
  link.click();
}
</script>

</body>
</html>
