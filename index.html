<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>PDF 強效標記工具 (穩定版)</title>
    <script src="https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.min.js"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; background: #323639; color: white; }
        #controls { 
            position: sticky; top: 0; z-index: 1000; 
            background: #202124; padding: 15px; 
            display: flex; gap: 12px; align-items: center; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        #pdf-container { display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .page-wrapper { 
            position: relative; margin-bottom: 25px; 
            background: white; border: 1px solid #000; 
            line-height: 0; 
        }
        canvas { display: block; }
        .highlight-box { 
            position: absolute; 
            background-color: rgba(0, 0, 0, 0.25); /* 灰階預覽 */
            border-bottom: 2px solid #000;       /* 粗底線 */
            pointer-events: none;
            mix-blend-mode: multiply;
        }
        input, button { padding: 10px; border-radius: 4px; border: 1px solid #555; font-size: 14px; }
        input[type="text"] { width: 280px; background: #fff; color: #000; }
        .btn-add { background: #3498db; color: white; border: none; font-weight: bold; cursor: pointer; }
        .btn-export { background: #27ae60; color: white; border: none; font-weight: bold; cursor: pointer; }
        button:disabled { background: #555; cursor: not-allowed; }
        #status { font-size: 13px; color: #bbb; margin-left: auto; }
    </style>
</head>
<body>

<div id="controls">
    <input type="file" id="fileInput" accept="application/pdf">
    <input type="text" id="keywordInput" placeholder="輸入關鍵字 (例如：合約,日期)">
    <button class="btn-add" id="addBtn" onclick="processSearch()" disabled>新增標記</button>
    <button class="btn-export" id="exportBtn" onclick="exportPDF()" disabled>匯出標記 PDF</button>
    <span id="status">請先開啟 PDF 檔案</span>
</div>

<div id="pdf-container"></div>

<script>
    const pdfjs = window['pdfjs-dist/build/pdf'];
    pdfjs.GlobalWorkerOptions.workerSrc = "https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.worker.min.js";

    const SCALE = 1.5;
    let originalPdfBytes = null;
    let pdfDoc = null;
    let pagesRecords = [];
    let allHighlights = [];

    // 1. 檔案載入
    document.getElementById("fileInput").addEventListener("change", async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const status = document.getElementById("status");
        status.innerText = "載入中...";
        
        try {
            originalPdfBytes = await file.arrayBuffer();
            // 使用副本防止數據被修改
            const loadingTask = pdfjs.getDocument({ data: new Uint8Array(originalPdfBytes) });
            pdfDoc = await loadingTask.promise;

            document.getElementById("pdf-container").innerHTML = "";
            pagesRecords = [];
            allHighlights = [];

            for (let i = 1; i <= pdfDoc.numPages; i++) {
                await renderPage(i);
            }

            status.innerText = `已載入 ${pdfDoc.numPages} 頁`;
            document.getElementById("addBtn").disabled = false;
            document.getElementById("exportBtn").disabled = false;
        } catch (err) {
            console.error(err);
            status.innerText = "檔案載入失敗！";
        }
    });

    // 2. 渲染頁面
    async function renderPage(pageNum) {
        const page = await pdfDoc.getPage(pageNum);
        const viewport = page.getViewport({ scale: SCALE });

        const wrapper = document.createElement("div");
        wrapper.className = "page-wrapper";
        wrapper.style.width = viewport.width + "px";
        wrapper.style.height = viewport.height + "px";

        const canvas = document.createElement("canvas");
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        wrapper.appendChild(canvas);

        const overlay = document.createElement("div");
        overlay.style.cssText = "position:absolute; inset:0; pointer-events:none;";
        wrapper.appendChild(overlay);

        document.getElementById("pdf-container").appendChild(wrapper);

        await page.render({ canvasContext: canvas.getContext("2d"), viewport }).promise;
        const textContent = await page.getTextContent();
        
        pagesRecords.push({ pageNum, viewport, textContent, overlay });
    }

    // 3. 搜尋邏輯
    function processSearch() {
        const input = document.getElementById("keywordInput").value.trim();
        if (!input || !pdfDoc) return;

        const keywords = input.split(",").map(k => k.trim().toLowerCase()).filter(k => k);
        let newCount = 0;

        pagesRecords.forEach(page => {
            page.textContent.items.forEach(item => {
                const text = item.str.toLowerCase();
                keywords.forEach(kw => {
                    if (text.includes(kw)) {
                        const [x, y, x2, y2] = page.viewport.convertToViewportRectangle([
                            item.transform[4],
                            item.transform[5],
                            item.transform[4] + item.width,
                            item.transform[5] + item.height
                        ]);

                        // 畫面標記
                        const box = document.createElement("div");
                        box.className = "highlight-box";
                        box.style.left = Math.min(x, x2) + "px";
                        box.style.top = Math.min(y, y2) + "px";
                        box.style.width = Math.max(1, Math.abs(x2 - x)) + "px";
                        box.style.height = Math.max(1, Math.abs(y2 - y)) + "px";
                        page.overlay.appendChild(box);

                        // 紀錄座標 (使用 PDF 物理座標)
                        allHighlights.push({
                            pageIdx: page.pageNum - 1,
                            x: item.transform[4],
                            y: item.transform[5],
                            w: item.width,
                            h: item.height
                        });
                        newCount++;
                    }
                });
            });
        });
        document.getElementById("status").innerText = `新增 ${newCount} 筆標記，總計 ${allHighlights.length} 筆`;
        document.getElementById("keywordInput").value = "";
    }

    // 4. 匯出邏輯 (重點修正區)
    async function exportPDF() {
        if (!allHighlights.length) {
            alert("目前沒有任何標記可供匯出！");
            return;
        }

        const status = document.getElementById("status");
        status.innerText = "正在生成 PDF 檔案...";
        
        try {
            // 初始化 PDF-Lib
            const { PDFDocument, rgb, BlendMode } = PDFLib;
            const pdfDocLib = await PDFDocument.load(originalPdfBytes);
            const pages = pdfDocLib.getPages();

            allHighlights.forEach(h => {
                if (h.pageIdx >= pages.length) return;
                
                const p = pages[h.pageIdx];
                
                // 1. 繪製灰色底塊 (影印辨識用)
                p.drawRectangle({
                    x: h.x,
                    y: h.y,
                    width: h.w,
                    height: h.h,
                    color: rgb(0.3, 0.3, 0.3), 
                    opacity: 0.25,
                    blendMode: BlendMode.Multiply
                });

                // 2. 繪製加粗黑底線 (黑白列印最強力證明)
                p.drawLine({
                    start: { x: h.x, y: h.y },
                    end: { x: h.x + h.w, y: h.y },
                    thickness: 1.5,
                    color: rgb(0, 0, 0),
                    opacity: 1
                });
            });

            // 儲存並下載
            const pdfBytes = await pdfDocLib.save();
            const blob = new Blob([pdfBytes], { type: "application/pdf" });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement("a");
            a.href = url;
            a.download = "Highlighted_B&W_Optimized.pdf";
            document.body.appendChild(a);
            a.click();
            
            // 清理
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 100);

            status.innerText = "匯出成功！檔案已下載。";
        } catch (err) {
            console.error("匯出過程發生錯誤:", err);
            status.innerText = "匯出失敗，詳細錯誤請見控制台 (F12)";
            alert("匯出失敗：可能是 PDF 檔案受保護或程式庫載入不完全。");
        }
    }
</script>

</body>
</html>
