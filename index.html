<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>PDF 強效標記工具 (診斷強化版)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
    <style>
        body { font-family: sans-serif; margin: 0; background: #323639; color: white; }
        #controls { 
            position: sticky; top: 0; z-index: 1000; 
            background: #202124; padding: 15px; 
            display: flex; gap: 12px; align-items: center; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        #pdf-container { display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .page-wrapper { position: relative; margin-bottom: 25px; background: white; border: 1px solid #000; }
        canvas { display: block; }
        .highlight-box { 
            position: absolute; 
            background-color: rgba(0, 0, 0, 0.25);
            border-bottom: 2px solid #000;
            pointer-events: none;
            mix-blend-mode: multiply;
        }
        input, button { padding: 10px; border-radius: 4px; border: 1px solid #555; }
        .btn-add { background: #3498db; color: white; border: none; font-weight: bold; cursor: pointer; }
        .btn-export { background: #27ae60; color: white; border: none; font-weight: bold; cursor: pointer; }
        #status { font-size: 13px; color: #bbb; margin-left: auto; }
    </style>
</head>
<body>

<div id="controls">
    <input type="file" id="fileInput" accept="application/pdf">
    <input type="text" id="keywordInput" placeholder="輸入關鍵字 (例如：合約)">
    <button class="btn-add" onclick="processSearch()">新增標記</button>
    <button class="btn-export" onclick="exportPDF()">匯出標記 PDF</button>
    <span id="status">等待檔案...</span>
</div>

<div id="pdf-container"></div>

<script>
    const pdfjsLib = window['pdfjs-dist/build/pdf'];
    pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

    const SCALE = 1.5;
    let originalPdfBytes = null;
    let pdfDoc = null;
    let pagesRecords = [];
    let allHighlights = [];

    document.getElementById("fileInput").addEventListener("change", async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        
        try {
            document.getElementById("status").innerText = "讀取中...";
            originalPdfBytes = await file.arrayBuffer();
            
            // 每次載入都使用新的副本以確保安全
            const loadingTask = pdfjsLib.getDocument({ data: new Uint8Array(originalPdfBytes.slice(0)) });
            pdfDoc = await loadingTask.promise;

            document.getElementById("pdf-container").innerHTML = "";
            pagesRecords = [];
            allHighlights = [];

            for (let i = 1; i <= pdfDoc.numPages; i++) {
                await renderPage(i);
            }
            document.getElementById("status").innerText = `已載入 ${pdfDoc.numPages} 頁`;
        } catch (err) {
            alert("載入 PDF 失敗: " + err.message);
        }
    });

    async function renderPage(pageNum) {
        const page = await pdfDoc.getPage(pageNum);
        const viewport = page.getViewport({ scale: SCALE });

        const wrapper = document.createElement("div");
        wrapper.className = "page-wrapper";
        wrapper.style.width = viewport.width + "px";
        wrapper.style.height = viewport.height + "px";

        const canvas = document.createElement("canvas");
        canvas.width = viewport.width;
        canvas.height = viewport.height;
        wrapper.appendChild(canvas);

        const overlay = document.createElement("div");
        overlay.style.cssText = "position:absolute; inset:0; pointer-events:none;";
        wrapper.appendChild(overlay);

        document.getElementById("pdf-container").appendChild(wrapper);

        await page.render({ canvasContext: canvas.getContext("2d"), viewport }).promise;
        const textContent = await page.getTextContent();
        pagesRecords.push({ pageNum, viewport, textContent, overlay });
    }

    function processSearch() {
        const input = document.getElementById("keywordInput").value.trim();
        if (!input || !pdfDoc) return;

        const keywords = input.split(",").map(k => k.trim().toLowerCase()).filter(k => k);
        let found = 0;

        pagesRecords.forEach(page => {
            page.textContent.items.forEach(item => {
                const text = item.str.toLowerCase();
                keywords.forEach(kw => {
                    if (text.includes(kw)) {
                        const [x1, y1, x2, y2] = page.viewport.convertToViewportRectangle([
                            item.transform[4], item.transform[5],
                            item.transform[4] + item.width, item.transform[5] + item.height
                        ]);

                        const box = document.createElement("div");
                        box.className = "highlight-box";
                        box.style.left = Math.min(x1, x2) + "px";
                        box.style.top = Math.min(y1, y2) + "px";
                        box.style.width = Math.abs(x2 - x1) + "px";
                        box.style.height = Math.abs(y2 - y1) + "px";
                        page.overlay.appendChild(box);

                        allHighlights.push({
                            pageIdx: page.pageNum - 1,
                            x: item.transform[4], y: item.transform[5],
                            w: item.width, h: item.height
                        });
                        found++;
                    }
                });
            });
        });
        document.getElementById("status").innerText = `已標記 ${found} 處`;
    }

    async function exportPDF() {
        if (!allHighlights.length) return alert("尚未標記任何關鍵字");
        
        document.getElementById("status").innerText = "執行匯出中...";
        
        try {
            // 確保 PDFLib 已載入
            if (typeof window.PDFLib === 'undefined') {
                throw new Error("PDF 處理庫載入失敗，請檢查網路連線。");
            }

            const { PDFDocument, rgb, BlendMode } = window.PDFLib;
            
            // 嘗試載入 PDF
            const pdfDocLib = await PDFDocument.load(new Uint8Array(originalPdfBytes.slice(0)));
            const pages = pdfDocLib.getPages();

            allHighlights.forEach(h => {
                if (h.pageIdx >= pages.length) return;
                const p = pages[h.pageIdx];
                
                // 畫灰色底塊
                p.drawRectangle({
                    x: h.x, y: h.y, width: h.w, height: h.h,
                    color: rgb(0.3, 0.3, 0.3), opacity: 0.25,
                    blendMode: BlendMode.Multiply
                });

                // 畫黑底線
                p.drawLine({
                    start: { x: h.x, y: h.y },
                    end: { x: h.x + h.w, y: h.y },
                    thickness: 1.5, color: rgb(0, 0, 0)
                });
            });

            const pdfBytes = await pdfDocLib.save();
            const blob = new Blob([pdfBytes], { type: "application/pdf" });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement("a");
            a.href = url;
            a.download = "Highlighted_ReadyToPrint.pdf";
            a.click();
            URL.revokeObjectURL(url);
            
            document.getElementById("status").innerText = "匯出成功！";
        } catch (err) {
            console.error(err);
            // 顯示具體錯誤，協助診斷
            document.getElementById("status").innerText = "匯出失敗";
            alert("匯出詳細錯誤訊息：\n" + err.message + "\n\n提示：如果是加密或掃描檔，可能無法直接修改。");
        }
    }
</script>

</body>
</html>
